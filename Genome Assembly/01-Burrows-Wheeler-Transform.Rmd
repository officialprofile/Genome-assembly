# Burrows-Wheeler transform {#bwt}

```{r include = FALSE}
library(stringr)
library(dplyr)
```

## Introduction
[Description]

## Burrows-Wheeler matrix

Consider the following sequence:
```{r}
sequence <- 'GATTACA'
```

In order to create the Burrows-Wheeler matrix for the given string we at first add the dollar sign $ at the end of the sequence.

```{r}
sequence  <- str_c(sequence, '$')
```

Afterwards we perform a series of shifts 
```{r}
sequences <- c(sequence)
n         <- nchar(sequence)

for (i in 1:(n-1)){
  sequence <- str_c(str_sub(sequence, 2, n),
                    str_sub(sequence, 1, 1))
  
  sequences <- c(sequences, sequence)
}

cat(sequences, sep = '\n')
```

Then we sort these sequences with the assumption that the dollar sign precedes lexicographically every symbol.

```{r}
sequences <- sort(sequences) 
cat(sequences, sep = '\n')
```

By putting every letter 

```{r}
bw.matrix           <- data.frame(matrix(, n, n))
colnames(bw.matrix) <- 1:n

for (i in 1:n){
  bw.matrix[i, ] <- strsplit(sequences[i], split = '')[[1]]
}

knitr::kable(bw.matrix)
```

Sequence at the very bottom of the Burrows-Wheeler matrix is called **Burrows-Wheeler transform**.

```{r}
transform <- paste(bw.matrix[,n], collapse = '')

cat('The Burrows-Wheeler transform of', 
    str_sub(sequence, 2, n), 'is', transform)
```

## Inverse transform

We are going to reconstruct the Burrows-Wheeler matrix and initial sequence itself. In order to do so one as first has to sort the transformed sequence.

```{r}
first.sequence <- strsplit(transform, split = '')[[1]] %>% sort
paste(first.sequence, collapse = '')
```

Note that this string is equal to the first column of the Burrrows-Wheeler transform. Also keep in mind that the characters from last and the first column are adjacent. 

```{r}
bw.inverse           <- data.frame(matrix(, n, 2))
colnames(bw.inverse) <- c(n, 1)

bw.inverse[, 1] <- strsplit(transform, split = '')[[1]]
bw.inverse[ ,2] <- first.sequence

knitr::kable(bw.inverse)
```

In other words, a this point we have a set of 2-mers.

```{r}
kmers <- apply(bw.inverse, 1, 
               function(x) paste(x, collapse = ''))
kmers
```

Once again, we strictly rely on the fact that Burrows-Wheeler matrix is sorted lexicographically. This allows us to reconstruct the remaining columns.

```{r}
kmers <- sort(kmers)
kmers
```

These 2-mers (k-mers in general) represent first two columns of the Burrows-Wheeler matrix.

We can derive last characters of the 2-mers in the following way:
```{r}
sapply(kmers, function(x) str_sub(x, 2, 2), 
       simplify = TRUE, USE.NAMES = FALSE)
```


```{r}
for (i in 2:(n-1)){
  kmers             <- apply(bw.inverse, 1, 
                             function(x) paste(x, collapse = ''))
  kmers             <- sort(kmers)
  bw.inverse[, i+1] <- sapply(kmers, function(x) str_sub(x, i, i), 
                              simplify = TRUE, USE.NAMES = FALSE)
  colnames(bw.inverse)[i+1] = i
}
knitr::kable(bw.inverse)
```

Finally we move first column to the very end

```{r}
bw.inverse[,n+1] <- bw.inverse[, 1]
bw.inverse       <- bw.inverse[,2:(n+1)]
colnames(bw.inverse)[n] = n

knitr::kable(bw.inverse)
```
One can also verify that bw.matrix and bw.inverse are in fact the same. 

```{r}
knitr::kable(bw.inverse == bw.matrix)
```

Additionally we can encapsulate Burrows-Wheeler transform in a function

```{r}
BWT <- function(sequence){
  sequence  <- str_c(sequence, '$')
  sequences <- c(sequence)
  n         <- nchar(sequence)

  for (i in 1:(n-1)){
    sequence <- str_c(str_sub(sequence, 2, n),
                     str_sub(sequence, 1, 1))
    sequences <- c(sequences, sequence)
  }
  sequences <- sort(sequences) 
  
  bw.matrix           <- data.frame(matrix(, n, n))
  colnames(bw.matrix) <- 1:n

  for (i in 1:n){
    bw.matrix[i, ] <- strsplit(sequences[i], split = '')[[1]]
  }
  return(paste(bw.matrix[,n], collapse = ''))
}
```

```{r}
BWT('GATTACA')
```
One can verify that this output is equal to result we obteined earlier.

Out of pure curiosity lets check the Burrows-Wheeler transform for a longer sequence.

```{r}
BWT('ATGCTCGTGCCATCATATAGCGCGCGCGCGATCTCTACGCGCG')
```
Please note that the input string has no identical characters at adjacent positions whereas in the transformed sequence such situation appears quite often. These substrings of identical characters will allow us represent the sequence in a more condensed manner.

## Applications